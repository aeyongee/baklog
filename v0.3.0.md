# 첫 피드백 반영 버전

- 테스터 3-4인의 서비스 사용 1일차 피드백을 반영한 개선해야할 기능입니다.

## Features

- 백로그 기능 : 다시 정의
  - 지금 기능을 먼저 설명해주세요
  - 내가 구현하고 싶은 백로그 기능 설명드리겠습니다.
    - Q1, Q2 : 생성된지 3일째 되었는데 아직 미완료 작업이면 백로그로 이동
    - Q3 : 생성된지 2일째인데 아직 미완료이면 이월 분류 팝업에서 분류했을때 처리하지 않는 작업이 되면 아카이브로 넘어가기
    - Q4 : 생성된 날에 완료 처리되지 않으면 바로 아카이브 (이월 분류 팝업에서도 조회 불가)
    - 결론적으로, 백로그는 중요한 작업인 Q1, Q2 작업이 적체되는 현상을 막기 위한 기능입니다
    - 백로그 alert 기준
      - Q1 : 백로그 페이지로 넘어온지 2일차부터 미완료시 매일 alert
      - Q2 : 백로그 페이지로 넘어온지 4일차부터 미완료시 매일 alert
  - 저의 요구사항대로 구현하면 동작이 어떻게 되는지 예를들어 설명해주세요. 아이젠하워메트릭스 기능과 의도가 맞는지도 확인해주세요.
- 작업 추가 > 오늘의 할 일 추가시, AI 분류하기 버튼 옆에 그냥 ‘직접 분류’ 버튼 생성
  - AI 분류하지않고 바로 직접 추가해서 분류 후 작업을 기록하고 싶다는 요구사항 발생했음
- 작업추가 > 특정 케이스에서 분류할 작업이 없다는 오류메시지가 발생함 → 이 부분 수정해주세요.
  - 특정 케이스 : 작업입력후 분류하기 버튼 누르고 분류하기 팝업에서, 뒤로가기 버튼눌렀을때 다시 작업 추가 화면으로 돌아오는데 여기서 분류하기 버튼을 누르면 하단에 작업이 남아있음에도 분류할 태스크가 없다고 에러가 남
- 오늘 > 오늘의 작업 > 완료 N건 보기가 너무 작아서 잘안보임 더 크게 수정해주세요.
- 오늘 > 오늘의 작업 > 이미 체크한 작업에 대해서 취소하지 못함. 오늘의 작업에 한해서는 실수로 체크하는 상황이 있으니까 체크해제를 눌렀을때 다시 원복되게해주세요.
- 체크했을때 체크하지않은 작업의 폰트보다 커지는것같으니 수정해주세요.
- 개인/업무를 같이 사용하는(온보딩설문) 사용자는 작업에 대해 업무/개인 태그가 있으면 좋겠다
  - 이 태그도 ai가 판단해서 붙여주도록 하는 게 좋을지 판단해주세요.
- 사용자 계정명 현재 왼쪽 상단에 있는데 로그아웃 버튼 옆에 있는게 자연스러워보임
  - 계정명을 표시하는 것이라는 것을 알수있도록 ui 수정필요
  - 계정명을 클릭했을때 설정 페이지가 나오고, 개인설정을 할수있는 기능을 추가하고싶다
    - 오늘 화면 기본 뷰 설정 : 리스트/사분면
    - 계정명/계정이메일/어떤소셜로그인인지(현재는 구글)

---

v0.3.0 구현 계획

Context

테스터 3~4인의 1일차 피드백을 반영한 개선 버전. 백로그 규칙 재정의, UX 개선, 신규 기능 추가를 포함.

---

Phase 1: DB 스키마 변경

파일: prisma/schema.prisma

- Task 모델에 category String? 필드 추가 (work/personal)
- UserPreference 모델에 defaultView String @default("list") 필드 추가

npx prisma migrate dev --name v030_category_defaultview
npx prisma generate

---

Phase 2: 백로그 규칙 재정의

파일: src/lib/rules/applyRules.ts

변경 사항

- Q1: 4일→3일 DailyPlan 포함시 backlogAt 설정 (alertAt 로직 제거)
- Q2: 4일→3일 DailyPlan 포함시 backlogAt 설정
- Q3: 기존 유지 (2일→needsReviewAt, 응답없으면 auto-archive)
- Q4: 기존 유지 (어제 포함 & 미완료→auto-archive)
- NEW - 백로그 alert: 메인 루프 끝에 추가
  - Q1: backlogAt로부터 2일 경과시 alertAt 설정
  - Q2: backlogAt로부터 4일 경과시 alertAt 설정

Q4 이월 팝업 제외

파일: src/app/today/setup/actions.ts - getCarryOverPreview()

- 반환 필터에 Q4 제외 조건 추가: (finalQuadrant ?? aiQuadrant) !== "Q4"
- Q4는 rule engine이 자동 아카이브 처리

---

Phase 3: 직접 분류 버튼 + 분류 버그 수정

3a. 분류 버그 수정

파일: src/app/today/setup/actions.ts - classifyDraftTasks()

- 쿼리 변경: status: "draft" → status: { in: ["draft", "classified"] }
- 뒤로가기 후 재분류 가능하게 함

3b. 직접 분류 서버 액션 추가

파일: src/app/today/setup/actions.ts

- manualClassifyDraftTasks() 함수 신규:
  - draft 상태 태스크를 AI 없이 classified로 변경
  - /today/review로 redirect

3c. UI 변경

파일: src/app/today/setup/setup-form.tsx

- hasDrafts → hasTasks 로 변경 (draft + classified 포함)
- ClassifyButton과 나란히 "직접 분류" 버튼 배치 (flex gap-3)

파일: src/app/today/setup/classify-button.tsx 또는 신규 manual-classify-button.tsx

- "직접 분류" 버튼 컴포넌트: manualClassifyDraftTasks() 호출
- pending 상태시 "이동 중..." 표시

3d. 리뷰 페이지 안내

파일: src/app/today/review/task-review-item.tsx

- task.aiQuadrant이 null이면 "직접 분류가 필요합니다" 힌트 텍스트 추가

---

Phase 4: 완료 토글 크기 + 폰트 일관성

4a. 완료 N건 보기 크기 확대

파일: src/app/today/task-list.tsx (line 72-75)

- text-xs text-gray-400 → text-sm font-medium text-gray-500 dark:text-gray-400

4b. 폰트 크기 일관성

파일: src/components/TaskCard.tsx

- 완료 태스크 텍스트(line 58): font-medium leading-snug 추가
- Active와 동일한 font-weight/line-height 보장

---

Phase 5: 체크 해제 (완료 취소) 기능

5a. 서버 액션

파일: src/app/today/actions.ts

- uncompleteTask(taskId) 추가: status: "completed" → "active", completedAt: null

5b. 컴포넌트 체인

파일: src/app/today/task-list.tsx

- uncompleteTask import 추가
- handleUncomplete 핸들러 추가
- ListView/MatrixView → 완료된 TaskCard에 onUncomplete prop 전달

5c. TaskCard 수정

파일: src/components/TaskCard.tsx

- onUncomplete prop 추가
- 완료 상태의 ✓ div → <button> 변경, 클릭시 uncomplete 실행
- hover시 시각적 피드백 (bg-green-200)

---

Phase 6: 개인/업무 태그

6a. AI 프롬프트 수정

파일: src/lib/ai/classifyTasks.ts

- JSON 응답 포맷에 category: "work" | "personal" 추가
- 카테고리 분류 규칙 추가 (업무/개인 기준 설명)
- ClassifyResult 인터페이스에 category?: string 추가
- 파싱시 유효성 검증 (work/personal만 허용)
- 함수 시그니처에 isMixed?: boolean 파라미터 추가

파일: src/lib/ai/buildCustomPrompt.ts

- mixed 사용자용 프롬프트에 카테고리 분류 지시 추가

6b. 분류 결과 저장

파일: src/app/today/setup/actions.ts - classifyDraftTasks()

- UserPreference에서 surveyAnswers 조회하여 isMixed 판단
- classifyTasks() 호출시 isMixed 전달
- DB 업데이트에 category: r.category ?? null 추가

6c. UI 표시

파일: src/components/TaskCard.tsx

- 뱃지 행에 category 뱃지 추가
  - work: 파란색 "업무" 뱃지
  - personal: 초록색 "개인" 뱃지

---

Phase 7: 계정 UI + 설정 모달

7a. 공통 헤더 컴포넌트 추출

신규: src/components/AppHeader.tsx (서버 컴포넌트)

- auth() 호출하여 세션 가져옴
- UserPreference 조회 (defaultView 등)
- 좌측: "Baklog" 브랜드
- 우측: UserSettingsButton(계정명 클릭) + 로그아웃 버튼
- 하단: 네비게이션 링크

7b. 설정 버튼 + 모달

신규: src/components/UserSettingsButton.tsx (클라이언트 컴포넌트)

- 유저 아이콘 + 이름 표시 버튼
- 클릭시 설정 모달 open

신규: src/components/SettingsModal.tsx (클라이언트 컴포넌트)

- 계정 정보: 이름, 이메일, Google 로그인 표시
- 설정: 기본 뷰 선택 (리스트/사분면) 토글
- CarryOverPopup과 동일한 모달 패턴 (fixed overlay)

7c. 설정 저장 서버 액션

신규 또는 기존: src/app/today/actions.ts에 updateDefaultView() 추가

7d. 레이아웃 파일 업데이트

4개 레이아웃 파일의 중복 헤더를 <AppHeader />로 교체:

- src/app/today/layout.tsx
- src/app/backlog/layout.tsx
- src/app/monthly/layout.tsx
- src/app/archive/layout.tsx

7e. 기본 뷰 적용

파일: src/app/today/page.tsx

- UserPreference의 defaultView 조회하여 TodayTaskList에 전달

파일: src/app/today/task-list.tsx

- defaultView prop 받아 초기 view state로 사용

---

수정 파일 요약
┌───────────────────────────────────────────┬───────────────────────────────────────────────────────────────────┐
│ 파일 │ 변경 내용 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ prisma/schema.prisma │ category, defaultView 필드 추가 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/lib/rules/applyRules.ts │ Q1/Q2 3일 규칙, 백로그 alert 로직 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/setup/actions.ts │ Q4 carry-over 필터, 분류 버그 수정, 직접 분류 액션, category 저장 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/setup/setup-form.tsx │ hasTasks 조건, 직접 분류 버튼 배치 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/setup/classify-button.tsx │ 또는 신규 manual-classify-button.tsx │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/review/task-review-item.tsx │ 직접분류 힌트 텍스트 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/task-list.tsx │ 완료 토글 크기, uncomplete 핸들러, defaultView prop │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/actions.ts │ uncompleteTask, updateDefaultView 액션 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/page.tsx │ defaultView 전달 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/components/TaskCard.tsx │ 폰트 일관성, uncomplete, category 뱃지 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/lib/ai/classifyTasks.ts │ category 응답, isMixed 파라미터 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/lib/ai/buildCustomPrompt.ts │ mixed 사용자 category 프롬프트 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/today/layout.tsx │ AppHeader 교체 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/backlog/layout.tsx │ AppHeader 교체 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/monthly/layout.tsx │ AppHeader 교체 │
├───────────────────────────────────────────┼───────────────────────────────────────────────────────────────────┤
│ src/app/archive/layout.tsx │ AppHeader 교체 │
└───────────────────────────────────────────┴───────────────────────────────────────────────────────────────────┘
신규 파일:
┌───────────────────────────────────────┬───────────────────────────┐
│ 파일 │ 용도 │
├───────────────────────────────────────┼───────────────────────────┤
│ src/components/AppHeader.tsx │ 공통 헤더 (서버 컴포넌트) │
├───────────────────────────────────────┼───────────────────────────┤
│ src/components/UserSettingsButton.tsx │ 계정명 버튼 (클라이언트) │
├───────────────────────────────────────┼───────────────────────────┤
│ src/components/SettingsModal.tsx │ 설정 모달 (클라이언트) │
└───────────────────────────────────────┴───────────────────────────┘

---

검증 방법

1.  npx prisma migrate dev 성공 확인
2.  npm run build 빌드 에러 없음 확인
3.  주요 시나리오 수동 테스트:

- 작업 추가 → 직접 분류 → 리뷰에서 수동 분류 → 확정
- 작업 추가 → AI 분류 → 뒤로가기 → 재분류 (에러 없음)
- 완료 체크 → 체크 해제 → 다시 active 상태
- 완료 N건 보기 크기 확인
- mixed 사용자의 태스크에 업무/개인 태그 표시
- 계정명 클릭 → 설정 모달 → 기본 뷰 변경 → 반영 확인
- 백로그 규칙: 3일 포함된 Q1/Q2 태스크가 백로그로 이동 확인

---

완료된 작업

Phase 1: DB 스키마

- Task.category (String?) 필드 추가
- UserPreference.defaultView (String, default "list") 필드 추가
- 마이그레이션 완료

Phase 2: 백로그 규칙

- Q1/Q2: 4일 → 3일 DailyPlan 포함시 backlogAt 설정
- 백로그 alert 신규: Q1은 backlogAt+2일, Q2는 backlogAt+4일 경과시 alertAt
- Q4 이월 팝업에서 제외 (rule engine이 자동 아카이브)

Phase 3: 직접 분류 + 버그 수정

- classifyDraftTasks() 쿼리: "draft" → { in: ["draft", "classified"] } (뒤로가기 후 재분류 가능)
- manualClassifyDraftTasks() 신규 액션
- "직접 분류" 버튼 UI 추가
- 리뷰 페이지에서 aiQuadrant null일 때 "직접 분류가 필요합니다" 힌트

Phase 4: UI 개선

- 완료 N건 보기 버튼 크기 확대 (text-sm font-medium)
- 완료 태스크 텍스트에 font-medium leading-snug 추가

Phase 5: 완료 취소

- uncompleteTask() 서버 액션
- TaskCard의 완료 ✓를 <button>으로 변경, 클릭시 uncomplete
- ListView/MatrixView에 onUncomplete prop 전달

Phase 6: 개인/업무 태그

- AI 프롬프트에 category 분류 추가 (mixed 사용자만)
- ClassifyResult에 category? 필드
- 분류 결과 DB 저장시 category 포함
- TaskCard에 파란색 "업무" / 초록색 "개인" 뱃지

Phase 7: 계정 UI + 설정

- AppHeader 공통 서버 컴포넌트 (Baklog 브랜드 + 유저 아이콘)
- UserSettingsButton + SettingsModal (계정 정보, 기본 뷰 토글)
- 4개 레이아웃 파일의 중복 헤더 → <AppHeader /> 교체
- getDefaultView() / updateDefaultView() 서버 액션
- TodayTaskList에 defaultView prop 전달

---

1. AI 분류하기, 직접 분류하기 버튼 인풋이랑 추가버튼이랑 동일 너비가 되게끔 너비조정

2. 직접 분류를 눌렀을때도 분류 결과 확인 페이지에서 'AI 분류 결과를 확인하고 필요시 수정하세요.'라는 문구가 나옴. 직접 분류하는 페이지인데 이 문구는 적합하지 않음
   - 그리고 작업들에서도 직접 분류가 필요하다는 안내 문구가 뜨는데 불필요해보임
3. 프로필 이미지가 깨지는 현상
4. 직접 작업을 분류할때는 개인/업무 태그도 직접 할당하도록 수정

---

1. 작업분류 페이지에서 업무/개인인지 설정하는게 중요함이랑 긴급함이랑 너무 똑같아서 뭐가뭔지모르겠어 그냥 사분면/리스트 처럼 표현해도 될거같은데
2. AI 분류하기, 직접 분류하기 버튼의 높이를 좀더 줄여줘
